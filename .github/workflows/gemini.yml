name: Gemini Code Assist Gatekeeper

# This workflow validates users before allowing Gemini Code Assist to be triggered.
# Since Gemini's config.yaml doesn't support user restrictions, we:
# 1. Disable auto code review in .gemini/config.yaml
# 2. Use this workflow to trigger Gemini only for approved users

on:
  # Trigger on new PRs to validate author and optionally trigger Gemini review
  pull_request:
    types: [opened, synchronize, reopened]

  # Trigger on comments to validate user before allowing @gemini mentions
  issue_comment:
    types: [created]

  pull_request_review_comment:
    types: [created]

jobs:
  # Job for PR events - validates PR author and triggers Gemini review
  validate-pr-author:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Check PR author authorization
        id: auth_check
        env:
          GH_TOKEN: ${{ github.token }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO: ${{ github.repository }}
        run: |
          # Whitelist of allowed usernames
          WHITELISTED_USERS="mcorrig4 claude-do"

          # Check if user is in whitelist
          for user in $WHITELISTED_USERS; do
            if [ "$PR_AUTHOR" = "$user" ]; then
              echo "PR author $PR_AUTHOR is whitelisted"
              echo "authorized=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          # Check if user is a repository collaborator
          PERMISSION=$(gh api "repos/$REPO/collaborators/$PR_AUTHOR/permission" --jq '.permission' 2>/dev/null || echo "none")

          if [ "$PERMISSION" = "admin" ] || [ "$PERMISSION" = "write" ] || [ "$PERMISSION" = "maintain" ]; then
            echo "PR author $PR_AUTHOR is a collaborator with $PERMISSION permission"
            echo "authorized=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "PR author $PR_AUTHOR is not authorized for Gemini review"
          echo "authorized=false" >> $GITHUB_OUTPUT

      - name: Trigger Gemini review for authorized PR
        if: steps.auth_check.outputs.authorized == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --body "@gemini-code-assist review"

      - name: Skip Gemini for unauthorized PR author
        if: steps.auth_check.outputs.authorized != 'true'
        run: |
          echo "::notice::Skipping Gemini review - PR author ${{ github.event.pull_request.user.login }} is not authorized"

  # Job for comment events - validates commenter before allowing @gemini
  validate-comment-author:
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@gemini')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Check commenter authorization
        id: auth_check
        env:
          GH_TOKEN: ${{ github.token }}
          COMMENTER: ${{ github.event.comment.user.login }}
          REPO: ${{ github.repository }}
        run: |
          # Whitelist of allowed usernames
          WHITELISTED_USERS="mcorrig4 claude-do"

          # Check if user is in whitelist
          for user in $WHITELISTED_USERS; do
            if [ "$COMMENTER" = "$user" ]; then
              echo "Commenter $COMMENTER is whitelisted"
              echo "authorized=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          # Check if user is a repository collaborator
          PERMISSION=$(gh api "repos/$REPO/collaborators/$COMMENTER/permission" --jq '.permission' 2>/dev/null || echo "none")

          if [ "$PERMISSION" = "admin" ] || [ "$PERMISSION" = "write" ] || [ "$PERMISSION" = "maintain" ]; then
            echo "Commenter $COMMENTER is a collaborator with $PERMISSION permission"
            echo "authorized=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Commenter $COMMENTER is not authorized to use Gemini"
          echo "authorized=false" >> $GITHUB_OUTPUT

      - name: Post warning for unauthorized Gemini usage
        if: steps.auth_check.outputs.authorized != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Determine if this is an issue or PR comment
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            gh issue comment ${{ github.event.issue.number }} \
              --repo ${{ github.repository }} \
              --body "⚠️ **Unauthorized Gemini Usage**

          @${{ github.event.comment.user.login }}, you are not authorized to trigger Gemini Code Assist. Only repository collaborators and approved users can use this feature.

          If you believe this is an error, please contact the repository maintainers."
          else
            gh pr comment ${{ github.event.pull_request.number }} \
              --repo ${{ github.repository }} \
              --body "⚠️ **Unauthorized Gemini Usage**

          @${{ github.event.comment.user.login }}, you are not authorized to trigger Gemini Code Assist. Only repository collaborators and approved users can use this feature.

          If you believe this is an error, please contact the repository maintainers."
          fi

      - name: Log authorized Gemini usage
        if: steps.auth_check.outputs.authorized == 'true'
        run: |
          echo "::notice::Authorized user ${{ github.event.comment.user.login }} triggered Gemini Code Assist"
